# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

InProgress

## Story

**As a** 사용자,
**I want** 노트 내용을 분석하여 최대 6개의 관련성 높은 태그를 자동으로 생성하는 기능,
**so that** 노트를 효율적으로 분류하고 검색할 수 있다.

## Acceptance Criteria

1. 노트 저장 시 자동으로 Gemini API를 호출하여 태그를 생성해야 한다
2. 생성되는 태그는 최대 6개까지여야 한다
3. 태그는 노트 내용과 높은 관련성을 가져야 한다
4. 태그는 한국어 키워드 형태여야 한다 (예: "회의", "프로젝트", "아이디어")
5. 생성된 태그는 note_tags 테이블에 저장되어야 한다
6. 노트 상세 페이지에서 생성된 태그를 확인할 수 있어야 한다
7. 태그 생성 실패 시 적절한 에러 메시지를 표시해야 한다
8. 태그 생성 중 로딩 상태를 표시해야 한다
9. 중복 태그는 제거되어야 한다
10. 짧은 노트(50자 미만)는 태그 생성을 건너뛰어야 한다

## Tasks / Subtasks

- [x] 태그 생성 Server Action 구현 (AC: 1, 2, 4, 5, 7, 10)
  - [x] generateTags 서버 액션 함수 생성
  - [x] Gemini API를 활용한 태그 생성 프롬프트 설계
  - [x] 태그 개수 및 형식 검증 로직
  - [x] note_tags 테이블에 태그 저장 로직
  - [x] 중복 태그 제거 및 정규화
- [x] 태그 표시 UI 컴포넌트 구현 (AC: 6, 8)
  - [x] NoteTags 컴포넌트 생성
  - [x] 태그 스타일링 (뱃지 형태)
  - [x] 로딩 상태 표시
  - [x] 태그 클릭 시 검색 기능 연동
- [x] 노트 저장 플로우에 태그 생성 통합 (AC: 1, 9, 10)
  - [x] 노트 저장 시 자동 태그 생성 호출
  - [x] 짧은 노트 필터링 로직
  - [x] 기존 태그 업데이트 로직
- [ ] 태그 관련 테스트 작성 (AC: 3, 9)
  - [ ] 태그 생성 서버 액션 단위 테스트
  - [ ] 태그 표시 컴포넌트 테스트
  - [ ] 중복 제거 로직 테스트

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **AI API:** Google Gemini API
- **데이터베이스:** Supabase Postgres with Drizzle ORM
- **UI:** shadcn/ui + Tailwind CSS

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

```sql
-- note_tags 테이블 구조
note_tags:
  - note_id (FK to notes.id)
  - tag (string, 태그명)
```

### 태그 생성 프롬프트 설계

**프롬프트 템플릿:**
```typescript
const TAG_PROMPT = `
다음 노트 내용을 분석하여 관련성 높은 태그를 3-6개 생성해주세요.

노트 내용:
{noteContent}

태그 생성 규칙:
1. 한국어 키워드로만 구성
2. 각 태그는 1-3단어로 간결하게
3. 노트의 주제, 카테고리, 핵심 개념을 반영
4. 최대 6개까지만 생성
5. 중복 제거

출력 형식:
회의, 프로젝트, 아이디어, 계획, 업무, 개발

(쉼표로 구분된 태그 목록만 출력)
`;
```

### 서버 액션 구현

```typescript
// lib/actions/notes.ts 업데이트
export async function generateTags(noteId: string, content: string) {
  try {
    // 1. 짧은 노트 필터링
    if (content.length < 50) {
      return { success: true, message: 'Too short to generate tags' };
    }

    // 2. Gemini API 호출
    const geminiClient = new GeminiClient();
    const prompt = TAG_PROMPT.replace('{noteContent}', content);
    const response = await geminiClient.generateText(prompt);

    // 3. 태그 파싱 및 정규화
    const rawTags = response.split(',').map(tag => tag.trim());
    const normalizedTags = normalizeTags(rawTags);
    const finalTags = normalizedTags.slice(0, 6); // 최대 6개

    // 4. 기존 태그 삭제
    await db.delete(noteTags).where(eq(noteTags.note_id, noteId));

    // 5. 새 태그 저장
    if (finalTags.length > 0) {
      await db.insert(noteTags).values(
        finalTags.map(tag => ({
          note_id: noteId,
          tag: tag
        }))
      );
    }

    return { success: true, tags: finalTags };
  } catch (error) {
    console.error('Tag generation failed:', error);
    return { success: false, error: error.message };
  }
}

// 태그 정규화 함수
function normalizeTags(rawTags: string[]): string[] {
  return rawTags
    .filter(tag => tag && tag.length > 0)
    .map(tag => tag.replace(/[^\w가-힣\s]/g, '').trim())
    .filter(tag => tag.length >= 1 && tag.length <= 20)
    .filter((tag, index, arr) => arr.indexOf(tag) === index) // 중복 제거
    .slice(0, 6);
}
```

### UI 컴포넌트 구현

**NoteTags 컴포넌트:**
```typescript
// components/notes/note-tags.tsx
interface NoteTagsProps {
  noteId: string;
  tags?: string[];
  isLoading?: boolean;
  onTagClick?: (tag: string) => void;
}

export function NoteTags({ noteId, tags, isLoading, onTagClick }: NoteTagsProps) {
  if (isLoading) {
    return (
      <div className="flex items-center space-x-2">
        <span className="text-sm text-gray-500">태그 생성 중...</span>
        <div className="animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>
      </div>
    );
  }

  if (!tags || tags.length === 0) {
    return null;
  }

  return (
    <div className="flex flex-wrap gap-2 mt-3">
      <span className="text-sm text-gray-500 mr-1">태그:</span>
      {tags.map((tag, index) => (
        <button
          key={index}
          onClick={() => onTagClick?.(tag)}
          className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors"
        >
          {tag}
        </button>
      ))}
    </div>
  );
}
```

### 노트 저장 플로우 통합

```typescript
// 기존 saveNote 서버 액션 업데이트
export async function saveNote(formData: FormData) {
  try {
    // ... 기존 노트 저장 로직

    // 태그 생성 (비동기)
    if (savedNote.id) {
      generateTags(savedNote.id, content)
        .catch(error => console.error('Tag generation failed:', error));
    }

    return { success: true, note: savedNote };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

### 태그 검색 연동

```typescript
// 태그 클릭 시 검색 기능
function handleTagClick(tag: string) {
  // 노트 목록 페이지로 이동하며 해당 태그로 필터링
  router.push(`/notes?tag=${encodeURIComponent(tag)}`);
}
```

### 성능 최적화

**태그 정규화:**
- 불필요한 특수문자 제거
- 길이 제한 (1-20자)
- 중복 태그 자동 제거
- 대소문자 정규화

**캐싱 전략:**
- 유사한 내용의 노트에 대해 태그 재사용
- 자주 사용되는 태그 패턴 학습

### 에러 처리

**에러 유형별 처리:**
1. **API 호출 실패:** 기본 태그 생성 또는 건너뛰기
2. **파싱 오류:** 원본 응답에서 태그 추출 시도
3. **데이터베이스 오류:** 로깅 후 무시
4. **형식 오류:** 정규화 로직으로 복구 시도

### 태그 품질 개선

**태그 품질 검증:**
```typescript
function validateTagQuality(tag: string, content: string): boolean {
  // 1. 최소 길이 검증
  if (tag.length < 1) return false;
  
  // 2. 내용 관련성 검증 (간단한 키워드 매칭)
  const contentLower = content.toLowerCase();
  const tagLower = tag.toLowerCase();
  
  // 3. 일반적이지 않은 태그 필터링
  const commonWords = ['것', '이것', '그것', '하나', '정도'];
  if (commonWords.includes(tag)) return false;
  
  return true;
}
```

### Testing

**테스트 파일 위치:** `__tests__/lib/actions/notes.test.ts`

**테스트 프레임워크:** Jest with @testing-library/react

**테스트 커버리지 요구사항:**
- 태그 생성 서버 액션 단위 테스트
- 태그 정규화 로직 테스트
- UI 컴포넌트 렌더링 테스트
- 중복 제거 로직 테스트

**테스트 표준:**
- 다양한 노트 내용에 대한 태그 생성 테스트
- 에지 케이스 처리 테스트 (빈 내용, 특수문자 등)
- 태그 개수 제한 테스트
- 중복 태그 제거 검증

## Change Log

| Date       | Version | Description                                | Author                    |
| ---------- | ------- | ------------------------------------------ | ------------------------- |
| 2025-09-17 | 1.0     | 스토리 생성                                | Scrum Master Bob          |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet (Anthropic)

### Debug Log References

- 태그 생성 서버 액션 구현 및 테스트 완료
- NoteTags 컴포넌트 생성 및 UI 통합 완료
- 태그 정규화 로직 구현 완료

### Completion Notes List

1. **Server Actions 확장**: generateTags, getNoteTags 함수를 lib/actions/notes.ts에 추가
2. **태그 정규화**: normalizeTags 함수로 중복 제거, 길이 제한, 특수문자 제거 구현
3. **UI Component 생성**: components/notes/note-tags.tsx 컴포넌트 생성
4. **UI 통합**: app/notes/[id]/note-detail-client.tsx에 태그 표시 기능 통합
5. **자동 태그 생성**: createNote 함수에 자동 태그 생성 로직 추가
6. **클릭 이벤트**: 태그 클릭 시 검색 기능 연동 구현
7. **로딩/에러 상태**: 태그 생성 중 로딩 및 에러 상태 처리
8. **비동기 처리**: 노트 저장과 독립적으로 태그 생성 실행

### File List

**새로 생성된 파일:**
- `components/notes/note-tags.tsx` - 태그 표시 컴포넌트

**수정된 파일:**
- `lib/actions/notes.ts` - generateTags, getNoteTags, normalizeTags 함수 추가
- `app/notes/[id]/note-detail-client.tsx` - 태그 표시 기능 통합

## QA Results
