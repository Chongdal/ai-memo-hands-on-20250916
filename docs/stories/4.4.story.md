# Story 4.4: AI 처리 상태 표시 (로딩, 완료, 에러)

## Status

InProgress

## Story

**As a** 사용자,
**I want** AI 요약 및 태그 생성 과정의 상태를 실시간으로 확인할 수 있는 기능,
**so that** AI 처리 진행상황을 파악하고 적절한 피드백을 받을 수 있다.

## Acceptance Criteria

1. AI 처리 시작 시 로딩 상태를 명확히 표시해야 한다
2. 로딩 상태는 스피너와 텍스트 메시지를 포함해야 한다
3. AI 처리 완료 시 성공 상태를 표시해야 한다
4. AI 처리 실패 시 에러 상태와 메시지를 표시해야 한다
5. 각 AI 기능(요약, 태그)별로 독립적인 상태를 관리해야 한다
6. 상태 변경 시 부드러운 애니메이션을 제공해야 한다
7. 에러 발생 시 재시도 버튼을 제공해야 한다
8. 처리 시간이 10초 이상 걸릴 경우 타임아웃 메시지를 표시해야 한다
9. 모바일에서도 상태 표시가 명확해야 한다
10. 접근성 지침을 준수해야 한다 (스크린 리더 지원)

## Tasks / Subtasks

- [x] AI 상태 관리 시스템 구현 (AC: 1, 2, 5)
  - [x] AIProcessingState 타입 정의
  - [x] useAIProcessing 커스텀 훅 생성
  - [x] 상태 전환 로직 구현
  - [x] 각 AI 기능별 상태 분리
- [x] 상태 표시 UI 컴포넌트 구현 (AC: 2, 3, 4, 6)
  - [x] AIStatusIndicator 컴포넌트 생성
  - [x] 로딩 스피너 컴포넌트
  - [x] 성공/에러 아이콘 및 메시지
  - [x] 애니메이션 효과 추가
- [x] 에러 처리 및 재시도 기능 (AC: 7, 8)
  - [x] 에러 메시지 표시 컴포넌트
  - [x] 재시도 버튼 구현
  - [x] 타임아웃 처리 로직
  - [x] 에러 타입별 메시지 분기
- [x] 접근성 및 반응형 대응 (AC: 9, 10)
  - [x] ARIA 레이블 추가
  - [x] 스크린 리더 지원
  - [x] 모바일 반응형 스타일링
  - [x] 키보드 네비게이션 지원

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind CSS + Radix UI
- **상태 관리:** React useState, useEffect
- **애니메이션:** Tailwind CSS transitions

### AI 처리 상태 타입 정의

```typescript
// lib/types/ai-status.ts
export enum AIProcessingStatus {
  IDLE = 'idle',
  PROCESSING = 'processing',
  SUCCESS = 'success',
  ERROR = 'error',
  TIMEOUT = 'timeout'
}

export interface AIProcessingState {
  status: AIProcessingStatus;
  message?: string;
  error?: string;
  startTime?: Date;
  endTime?: Date;
}

export interface AIProcessingStates {
  summary: AIProcessingState;
  tags: AIProcessingState;
}
```

### 커스텀 훅 구현

```typescript
// hooks/use-ai-processing.ts
import { useState, useCallback } from 'react';

export function useAIProcessing() {
  const [states, setStates] = useState<AIProcessingStates>({
    summary: { status: AIProcessingStatus.IDLE },
    tags: { status: AIProcessingStatus.IDLE }
  });

  const startProcessing = useCallback((type: 'summary' | 'tags') => {
    setStates(prev => ({
      ...prev,
      [type]: {
        status: AIProcessingStatus.PROCESSING,
        message: type === 'summary' ? 'AI 요약 생성 중...' : 'AI 태그 생성 중...',
        startTime: new Date()
      }
    }));
  }, []);

  const setSuccess = useCallback((type: 'summary' | 'tags', result?: any) => {
    setStates(prev => ({
      ...prev,
      [type]: {
        status: AIProcessingStatus.SUCCESS,
        message: type === 'summary' ? '요약 생성 완료' : '태그 생성 완료',
        endTime: new Date()
      }
    }));
  }, []);

  const setError = useCallback((type: 'summary' | 'tags', error: string) => {
    setStates(prev => ({
      ...prev,
      [type]: {
        status: AIProcessingStatus.ERROR,
        error: error,
        message: type === 'summary' ? '요약 생성 실패' : '태그 생성 실패',
        endTime: new Date()
      }
    }));
  }, []);

  const setTimeout = useCallback((type: 'summary' | 'tags') => {
    setStates(prev => ({
      ...prev,
      [type]: {
        status: AIProcessingStatus.TIMEOUT,
        message: '처리 시간이 초과되었습니다',
        error: 'Timeout',
        endTime: new Date()
      }
    }));
  }, []);

  const reset = useCallback((type: 'summary' | 'tags') => {
    setStates(prev => ({
      ...prev,
      [type]: { status: AIProcessingStatus.IDLE }
    }));
  }, []);

  return {
    states,
    startProcessing,
    setSuccess,
    setError,
    setTimeout,
    reset
  };
}
```

### 상태 표시 컴포넌트

```typescript
// components/ai/ai-status-indicator.tsx
import { AIProcessingState, AIProcessingStatus } from '@/lib/types/ai-status';
import { Loader2, CheckCircle, XCircle, Clock } from 'lucide-react';

interface AIStatusIndicatorProps {
  state: AIProcessingState;
  type: 'summary' | 'tags';
  onRetry?: () => void;
}

export function AIStatusIndicator({ state, type, onRetry }: AIStatusIndicatorProps) {
  const getIcon = () => {
    switch (state.status) {
      case AIProcessingStatus.PROCESSING:
        return <Loader2 className="h-4 w-4 animate-spin text-blue-500" />;
      case AIProcessingStatus.SUCCESS:
        return <CheckCircle className="h-4 w-4 text-green-500" />;
      case AIProcessingStatus.ERROR:
        return <XCircle className="h-4 w-4 text-red-500" />;
      case AIProcessingStatus.TIMEOUT:
        return <Clock className="h-4 w-4 text-orange-500" />;
      default:
        return null;
    }
  };

  const getStatusColor = () => {
    switch (state.status) {
      case AIProcessingStatus.PROCESSING:
        return 'text-blue-600';
      case AIProcessingStatus.SUCCESS:
        return 'text-green-600';
      case AIProcessingStatus.ERROR:
        return 'text-red-600';
      case AIProcessingStatus.TIMEOUT:
        return 'text-orange-600';
      default:
        return 'text-gray-600';
    }
  };

  if (state.status === AIProcessingStatus.IDLE) {
    return null;
  }

  return (
    <div 
      className="flex items-center space-x-2 p-2 rounded-lg bg-gray-50 transition-all duration-300"
      role="status"
      aria-live="polite"
    >
      {getIcon()}
      <span className={`text-sm font-medium ${getStatusColor()}`}>
        {state.message}
      </span>
      
      {state.status === AIProcessingStatus.ERROR && onRetry && (
        <button
          onClick={onRetry}
          className="text-xs text-blue-600 hover:text-blue-800 underline ml-2"
          aria-label={`${type} 재시도`}
        >
          재시도
        </button>
      )}
      
      {state.error && (
        <span className="text-xs text-gray-500 ml-2">
          ({state.error})
        </span>
      )}
    </div>
  );
}
```

### 통합 AI 상태 컨테이너

```typescript
// components/ai/ai-processing-container.tsx
export function AIProcessingContainer({ noteId }: { noteId: string }) {
  const { states, startProcessing, setSuccess, setError, reset } = useAIProcessing();

  const handleRetrySummary = useCallback(async () => {
    reset('summary');
    startProcessing('summary');
    
    try {
      const result = await generateSummary(noteId, noteContent);
      if (result.success) {
        setSuccess('summary', result.summary);
      } else {
        setError('summary', result.error || 'Unknown error');
      }
    } catch (error) {
      setError('summary', error.message);
    }
  }, [noteId, noteContent]);

  const handleRetryTags = useCallback(async () => {
    reset('tags');
    startProcessing('tags');
    
    try {
      const result = await generateTags(noteId, noteContent);
      if (result.success) {
        setSuccess('tags', result.tags);
      } else {
        setError('tags', result.error || 'Unknown error');
      }
    } catch (error) {
      setError('tags', error.message);
    }
  }, [noteId, noteContent]);

  return (
    <div className="space-y-3">
      <AIStatusIndicator
        state={states.summary}
        type="summary"
        onRetry={handleRetrySummary}
      />
      <AIStatusIndicator
        state={states.tags}
        type="tags"
        onRetry={handleRetryTags}
      />
    </div>
  );
}
```

### 타임아웃 처리

```typescript
// lib/utils/ai-timeout.ts
export function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number = 10000
): Promise<T> {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) =>
      setTimeout(() => reject(new Error('Timeout')), timeoutMs)
    )
  ]);
}

// 사용 예시
export async function generateSummaryWithTimeout(noteId: string, content: string) {
  try {
    return await withTimeout(generateSummary(noteId, content), 10000);
  } catch (error) {
    if (error.message === 'Timeout') {
      throw new Error('요청 시간이 초과되었습니다. 다시 시도해주세요.');
    }
    throw error;
  }
}
```

### 접근성 개선

```typescript
// 스크린 리더를 위한 상태 알림
export function AIStatusAnnouncer({ state }: { state: AIProcessingState }) {
  return (
    <div
      className="sr-only"
      aria-live="assertive"
      aria-atomic="true"
    >
      {state.status === AIProcessingStatus.PROCESSING && state.message}
      {state.status === AIProcessingStatus.SUCCESS && `${state.message} 완료되었습니다.`}
      {state.status === AIProcessingStatus.ERROR && `오류가 발생했습니다: ${state.error}`}
    </div>
  );
}
```

### 모바일 반응형 스타일

```css
/* 모바일에서 상태 표시 최적화 */
@media (max-width: 640px) {
  .ai-status-indicator {
    @apply text-xs p-1.5;
  }
  
  .ai-status-indicator .icon {
    @apply h-3 w-3;
  }
  
  .ai-retry-button {
    @apply text-xs px-2 py-1;
  }
}
```

### 성능 최적화

**상태 업데이트 최적화:**
- React.memo를 사용한 불필요한 리렌더링 방지
- useCallback을 통한 함수 메모이제이션
- 상태 변경 시 필요한 컴포넌트만 업데이트

**애니메이션 최적화:**
- CSS transitions 사용으로 GPU 가속 활용
- transform 속성 사용으로 레이아웃 변경 최소화

### Testing

**테스트 파일 위치:**
- `__tests__/hooks/use-ai-processing.test.ts`
- `__tests__/components/ai/ai-status-indicator.test.tsx`

**테스트 프레임워크:** Jest with @testing-library/react

**테스트 커버리지 요구사항:**
- 상태 전환 로직 테스트
- UI 컴포넌트 렌더링 테스트
- 접근성 속성 테스트
- 에러 처리 시나리오 테스트

**테스트 표준:**
- 모든 상태 전환 시나리오 테스트
- 사용자 상호작용 테스트 (재시도 버튼 클릭 등)
- 접근성 속성 검증 (aria-live, role 등)
- 타임아웃 처리 테스트

## Change Log

| Date       | Version | Description                                | Author                    |
| ---------- | ------- | ------------------------------------------ | ------------------------- |
| 2025-09-17 | 1.0     | 스토리 생성                                | Scrum Master Bob          |

## Dev Agent Record

### Agent Model Used

Claude 4 Sonnet (Anthropic)

### Debug Log References

- AI 상태 관리 시스템 구현 완료
- AIStatusIndicator 컴포넌트 생성 및 통합 완료
- 타임아웃 처리 및 재시도 기능 구현 완료

### Completion Notes List

1. **타입 시스템 구축**: lib/types/ai-status.ts에 AI 처리 상태 관련 타입 정의
2. **커스텀 훅 구현**: hooks/use-ai-processing.ts에 상태 관리 로직 구현
3. **상태 표시 컴포넌트**: components/ai/ai-status-indicator.tsx 생성
4. **통합 컨테이너**: components/ai/ai-processing-container.tsx로 통합 관리
5. **기존 컴포넌트 개선**: NoteSummary, NoteTags 컴포넌트에 새 상태 시스템 통합
6. **타임아웃 처리**: 10초 타임아웃 자동 처리 구현
7. **재시도 기능**: 에러 발생 시 재시도 버튼 제공
8. **접근성 지원**: ARIA 레이블 및 스크린 리더 지원 구현
9. **하위 호환성**: 기존 레거시 props 지원으로 점진적 마이그레이션 가능

### File List

**새로 생성된 파일:**
- `lib/types/ai-status.ts` - AI 처리 상태 타입 정의
- `hooks/use-ai-processing.ts` - AI 상태 관리 커스텀 훅
- `components/ai/ai-status-indicator.tsx` - 상태 표시 컴포넌트
- `components/ai/ai-processing-container.tsx` - 통합 AI 처리 컨테이너

**수정된 파일:**
- `components/notes/note-summary.tsx` - 새 상태 시스템 통합
- `components/notes/note-tags.tsx` - 새 상태 시스템 통합

## QA Results
